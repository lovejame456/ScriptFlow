# M16.7 Gold Baseline 自动晋升机制

## 概述

M16.7 实现 Gold Baseline 自动晋升机制，确保 baseline 可控演进、可回滚。这是 M16 Metrics 系统的最后一块拼图，实现了从"基准线"到"金标准"的完整闭环。

## 核心概念

### Gold Baseline

Gold Baseline 是经过验证的高质量 Metrics 快照，作为系统演进的"锚点"。

- **位置**：`baseline/gold/m16_metrics_gold.json`
- **更新方式**：只有通过 Promotion Gate 才能晋升
- **回滚能力**：每次晋升前会备份旧 Gold 到 history

### Promotion Gate

Promotion Gate 是一套严格的质量门禁，只有连续 2 次通过才能晋升 Gold Baseline。

#### Gate 条件（必须全部满足）

1. **健康评分提升**
   - `current.health.score >= max(gold.score + 3, 70)`
   - 至少提升 3 分，且不低于 70 分
   - 冷启动时（无 Gold），最低要求 70 分

2. **零错误**
   - `current.health.errors.length === 0`
   - 任何结构错误都会阻止晋升

3. **低重试率**
   - `current.retry.p95Retries <= 1`
   - P95 重试次数必须 <= 1

### Pending 机制

Pending 机制确保晋升不是偶然事件，要求连续 2 次通过 Gate。

- **第一次通过**：写入 `baseline/gold/pending.json`
  ```json
  {
    "runId": "run-pass-1",
    "metricsPath": "/path/to/metrics.json",
    "timestamp": "2026-01-03T12:00:00.000Z"
  }
  ```

- **第二次通过（相同 runId）**：晋升 Gold + 写 history + 清空 pending

- **非连续通过（不同 runId）**：替换 pending，不晋升

- **Gate 失败**：清空 pending，不晋升

### History 留档

每次晋升 Gold Baseline 时，旧 Gold 会自动备份到 `baseline/gold/history/` 目录。

**文件命名**：`{timestamp}_{runId}.json`

**示例**：
- `1704259200000_gold-v1.0.json`
- `1704262800000_gold-v1.1.json`

**回滚流程**：
1. 找到要回滚的历史版本
2. 复制到 `baseline/gold/m16_metrics_gold.json`
3. 清空 `baseline/gold/pending.json`

## CI 集成

### Main 分支 Push

```yaml
m16-gold-promotion:
  needs: m16-regression-gate
  if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  runs-on: ubuntu-latest
  steps:
    - name: Checkout code
    - name: Setup Node.js
    - name: Install dependencies
    - name: Download current metrics
    - name: Run Gold Baseline Promotion
      run: npm run gold:promote -- <metrics_path>
    - name: Upload Gold Baseline
```

### PR 分支

PR 分支**不运行** Gold Promotion：
- `if: github.ref == 'refs/heads/main' && github.event_name == 'push'`
- PR 只跑测试，不允许晋升 Baseline

## 使用方式

### 本地测试

```bash
# 运行 Gold Promotion 测试
npm run test:m16.7

# 手动运行 Promotion（传入 metrics 路径）
npm run gold:promote -- reports/test-metrics.json
```

### CI 自动化

在 main 分支 push 后，CI 自动执行：
1. 运行 M16.4 metrics 测试
2. 生成 metrics JSON
3. 运行 Gold Promotion
4. 上传 Gold Baseline artifact

## 实施细节

### Promotion Gate 验证

```typescript
function checkPromotionGate(current: MetricsData, gold: MetricsData | null): PromotionGateResult {
  const reasons: string[] = [];
  let passed = true;

  // 条件 1: Score >= max(gold.score + 3, 70)
  const minScore = gold ? Math.max(gold.aggregates.health.score + 3, 70) : 70;
  const scoreCondition = current.aggregates.health.score >= minScore;

  if (!scoreCondition) {
    reasons.push(`Score ${current.score} < ${minScore}`);
    passed = false;
  }

  // 条件 2: errors.length === 0
  const errorsCondition = current.aggregates.health.errors.length === 0;

  if (!errorsCondition) {
    reasons.push(`Errors ${current.errors.length} > 0`);
    passed = false;
  }

  // 条件 3: p95Retries <= 1
  const retriesCondition = current.aggregates.retry.p95Retries <= 1;

  if (!retriesCondition) {
    reasons.push(`P95 retries ${current.retries} > 1`);
    passed = false;
  }

  return { passed, scoreCondition, errorsCondition, retriesCondition, reasons };
}
```

### Pending 状态管理

```typescript
function managePendingState(current: MetricsData, pending: PendingState | null, gatePassed: boolean) {
  if (!gatePassed) {
    // Gate 失败：清空 pending
    clearPendingState();
    return;
  }

  if (!pending) {
    // 第一次通过：写入 pending
    const newPending: PendingState = {
      runId: current.runId,
      metricsPath: metricsPath,
      timestamp: new Date().toISOString()
    };
    writePendingState(newPending);
  } else if (pending.runId === current.runId) {
    // 连续通过：晋升
    promoteToGold(current, metricsPath);
    clearPendingState();
  } else {
    // 不连续：替换 pending
    const newPending: PendingState = {
      runId: current.runId,
      metricsPath: metricsPath,
      timestamp: new Date().toISOString()
    };
    writePendingState(newPending);
  }
}
```

### Gold 晋升流程

```typescript
function promoteToGold(current: MetricsData, metricsPath: string): void {
  const goldPath = 'baseline/gold/m16_metrics_gold.json';
  const historyDir = 'baseline/gold/history';

  // 1. 备份当前 Gold 到 History
  if (fs.existsSync(goldPath)) {
    const oldGold = JSON.parse(fs.readFileSync(goldPath, 'utf-8'));
    const oldTimestamp = new Date(oldGold.timestamp).getTime();
    const historyPath = `${historyDir}/${oldTimestamp}_${oldGold.runId}.json`;
    fs.writeFileSync(historyPath, JSON.stringify(oldGold, null, 2));
  }

  // 2. 写入新的 Gold
  fs.writeFileSync(goldPath, JSON.stringify(current, null, 2));
}
```

## 文件结构

```
baseline/
├── m16_metrics_baseline.json          # 手动维护的基准线（不允许自动覆盖）
└── gold/                             # Gold Baseline（自动演进）
    ├── m16_metrics_gold.json           # 当前 Gold Baseline
    ├── pending.json                   # Pending 状态（可选）
    └── history/                      # 历史 Gold 留档
        ├── 1704259200000_gold-v1.0.json
        ├── 1704262800000_gold-v1.1.json
        └── ...
```

## 与 M16.6 的关系

M16.7 是 M16.6 Meta Policy 的延伸：

- **M16.6**：跨项目学习，生成 `meta_policy.json`
- **M16.7**：Gold Baseline 自动晋升，控制 baseline 演进

两者共同构建了 Metrics 系统的完整闭环：

```
metrics_pool/ → meta_policy.json (M16.6) → policy_engine (M16.5)
→ adaptive_params → structure_planner → generation
→ metrics → gold_baseline (M16.7) → history
```

## 测试覆盖

测试脚本：`scripts/test-m16.7-gold-promote.ts`

### 测试场景

1. **Cold start，第一次通过 gate**
   - 写入 pending，不晋升
   - Gold baseline 不存在

2. **第二次连续通过**
   - 晋升 gold
   - History 生成备份
   - Pending 清空

3. **Gate 失败**
   - 不覆盖 gold
   - Pending 清空
   - 验证 score/errors/retries 条件

4. **非连续通过**
   - Pending 被替换
   - Gold 不晋升

### 运行测试

```bash
npm run test:m16.7
```

## 安全保障

### 禁止自动覆盖

- `baseline/m16_metrics_baseline.json`：**严禁**自动覆盖
- 只有 `baseline/gold/*` 可以自动更新

### Git 忽略

建议在 `.gitignore` 中添加：

```gitignore
# M16.7 Gold Baseline
baseline/gold/pending.json
```

但**保留**以下文件：
- `baseline/gold/m16_metrics_gold.json`（提交到 Git）
- `baseline/gold/history/*.json`（提交到 Git，保留历史）

### 回滚策略

如果新 Gold 导致问题：

1. **快速回滚**（无需提交）：
   ```bash
   # 找到历史版本并复制
   cp baseline/gold/history/{timestamp}_{old_run_id}.json baseline/gold/m16_metrics_gold.json
   ```

2. **Git 回滚**（推荐）：
   ```bash
   # 回退到上一个 Gold 提交
   git log --oneline -- baseline/gold/m16_metrics_gold.json
   git checkout <commit_hash> -- baseline/gold/m16_metrics_gold.json
   git commit -m "Rollback Gold Baseline"
   ```

## PM 审计重点

实施完成后，PM 需要验证以下关键点：

### P0 Hotfix 验证

1. **pressureMultiplier 语义**
   - `< 0.9` 真的变"更柔"（移除硬词、精简提示）
   - `> 1.1` 真的变"更强"（加入硬词、增加提示）

2. **unknown bucket 排除**
   - `meta_policy.json` 不再出现 `unknown__MID` 桶
   - Unknown 只做 cold-start fallback

### M16.6.1 稳定性验证

3. **errorRate Beta 平滑**
   - 样本少时 errorRate 不会暴涨到 100%
   - 使用 `(errors + 1) / (n + 2)` 平滑公式

4. **SPIKE 上限 cap**
   - `determineCadenceTag` 应用 0.45 上限
   - EP6/12/18 强制 SPIKE 不受 cap 影响

### M16.7 Gold Baseline 验证

5. **Promotion Gate 正确性**
   - 本地运行测试：`npm run test:m16.7`
   - CI main push 第二次满足条件后：
     - `baseline/gold/m16_metrics_gold.json` 更新
     - `baseline/gold/history/...` 留档
     - `baseline/gold/pending.json` 被清空

6. **CI 集成验证**
   - PR 不运行 promotion（只跑测试）
   - Main push 运行 promotion（满足条件才晋升）

## 验收标准

- 所有测试通过：`npm run test:m16.7`
- PM 审计全部 6 个关键点
- CI 日志显示正确的 PASSED/FAILED 信息
- 任何情况下不覆盖 `baseline/m16_metrics_baseline.json`

## 后续优化建议

1. **可视化仪表盘**
   - 展示 Gold 演进历史
   - 对比不同 Gold 版本的 Metrics 差异

2. **自动回滚**
   - 如果新 Gold 导致测试失败，自动回滚到上一个版本

3. **Promotion 条件调优**
   - 根据实际运行数据调整 Gate 条件
   - 例如：降低 score 提升要求或放宽 p95Retries

## 总结

M16.7 Gold Baseline 实现了：

1. **可控演进**：只有通过严格 Gate 才能晋升
2. **可回滚**：History 留档支持快速回退
3. **安全机制**：Pending 防止偶然晋升
4. **CI 集成**：自动化 promotion 流程

配合 P0 hotfix 和 M16.6.1 稳定性补丁，M16.7 完成了整个 Metrics 系统的最后一块拼图，实现了从"观测"到"优化"的完整闭环。

