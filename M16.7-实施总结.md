# M16.7 Gold Baseline 与 P0 修复 - 实施总结

## 实施完成时间

2026-01-03

## 实施范围

### P0 HOTFIX #1：修复 pressureMultiplier 语义

**问题**：pressureMultiplier 语义反直觉
- 原逻辑：`< 0.9` 加"高优先级"，`> 1.1` 加"标准优先级"
- 影响：降压时提示更强，加压时提示更柔，完全反向

**修复**：
- **文件**：`lib/ai/antagonistBinder.ts`
  - `< 0.9`：移除"必须/强制"，改为"尽量/建议"（更温和）
  - `> 1.1`：加入"必须/强制"（更强硬）
  - `< 0.9`：保留前 2 条提示（精简）
  - `> 1.1`：追加 1-2 条可验证/后果提示（增强）

- **文件**：`scripts/test-m16.5-adaptive-scheduling.ts`
  - 更新测试断言，验证语义正确性

**验收**：语义统一，`< 0.9` 真的更柔，`> 1.1` 真的更强

---

### P0 HOTFIX #2：unknown bucket 不参与 meta 学习

**问题**：unknown__MID 桶参与学习，导致偏置不可解释且不可信

**修复**：
- **文件**：`lib/metrics/metaAggregator.ts`
  - 在 `buildMetaPolicy` 中添加过滤逻辑
  - 检查 `genre === 'unknown'` 或为空
  - 跳过这些桶，不计入 buckets 聚合
  - 输出日志说明 unknown 桶被排除

**验收**：`meta_policy.json` 不再出现 `unknown__MID` 桶

---

### M16.6.1 稳定性补丁 #1：errorRate Beta 平滑

**问题**：样本数少时（如 n=2），一次结构 fail 就会让 errorRate=100%，导致策略极端

**修复**：
- **文件**：`lib/metrics/metaTypes.ts`
  - 在 `BucketStats` 接口添加 `errorRateSmoothed: number` 字段

- **文件**：`lib/metrics/metaAggregator.ts`
  - 在 `aggregateBucketStats` 中计算平滑 errorRate
  - 公式：`errorRateSmoothed = (runsWithErrors + 1) / (sampleCount + 2)`
  - 同时返回 raw 和 smoothed 值
  - 在 `deriveMetaPolicyBias` 中使用 smoothed errorRate

**效果**：n=2 时最多 67% 而非 100%，防止极端策略

---

### M16.6.1 稳定性补丁 #2：SPIKE 上限 cap

**问题**：SPIKE_UP 规则可能导致反馈环路震荡
- SPIKE_UP → 更强剧情 → SlotWriter 更贴边 → 重试上升 → score 降低 → SPIKE_UP

**修复**：
- **文件**：`lib/ai/structurePlanner.ts`
  - 在 `determineCadenceTag` 中添加 SPIKE 概率上限
  - `const SPIKE_CAP = 0.45`
  - 所有概率调整都应用上限：`Math.min(spikeProbability, SPIKE_CAP)`
  - EP6/12/18 强制 SPIKE 不受 cap 影响

**效果**：防止 SPIKE 频率无限制上调，避免震荡

---

### M16.7：Gold Baseline & Promotion Gate

**目标**：实现 Baseline 可控演进、可回滚

**实现**：

#### 核心脚本
- **文件**：`scripts/m16-gold-promote.ts`（新增）
  - `readMetrics()`：读取当前 run metrics
  - `readGoldBaseline()`：读取 current gold（不存在则 cold start）
  - `readPendingState()`：读取 pending 状态
  - `checkPromotionGate()`：检查 Promotion Gate 条件
    - 条件 1：`score >= max(gold.score + 3, 70)`
    - 条件 2：`errors.length === 0`
    - 条件 3：`p95Retries <= 1`
  - `managePendingState()`：管理 pending 机制
    - 第一次通过 → 写 pending
    - 第二次连续 → 晋升 gold + 清空 pending
    - 非连续 → 替换 pending
    - 失败 → 清空 pending
  - `promoteToGold()`：晋升 gold baseline
    - 备份旧 gold 到 `baseline/gold/history/`
    - 写入新 gold 到 `baseline/gold/m16_metrics_gold.json`

#### 测试脚本
- **文件**：`scripts/test-m16.7-gold-promote.ts`（新增）
  - 测试 1：Cold start，第一次通过 → 写 pending，不晋升
  - 测试 2：第二次连续通过 → 晋升 gold + history 留档
  - 测试 3：Gate 失败（score 不够/errors/p95>1）→ 不覆盖 gold
  - 测试 4：非连续通过 → pending 被替换但不晋升

#### CI 集成
- **文件**：`.github/workflows/ci.yml`
  - 新增 `m16-gold-promotion` job
  - 条件限制：`if: github.ref == 'refs/heads/main' && github.event_name == 'push'`
  - PR 只跑测试，不允许晋升 baseline

#### NPM 脚本
- **文件**：`package.json`
  - 新增 `"test:m16.7": "tsx scripts/test-m16.7-gold-promote.ts"`
  - 新增 `"gold:promote": "tsx scripts/m16-gold-promote.ts"`

#### 文档
- **文件**：`docs/M16.7_GOLD_BASELINE.md`（新增）
  - Gold Baseline 概念说明
  - Promotion Gate 条件详解
  - Pending 机制说明
  - History 留档结构
  - CI 集成方式
  - 回滚流程
  - PM 审计重点

---

## 文件清单

### 修改的文件

1. `lib/ai/antagonistBinder.ts` - P0 #1 修复 pressureMultiplier 语义
2. `scripts/test-m16.5-adaptive-scheduling.ts` - 更新测试断言
3. `lib/metrics/metaAggregator.ts` - P0 #2 + M16.6.1 Beta 平滑
4. `lib/metrics/metaTypes.ts` - M16.6.1 添加 errorRateSmoothed 字段
5. `lib/ai/structurePlanner.ts` - M16.6.1 SPIKE cap
6. `.github/workflows/ci.yml` - M16.7 CI 集成
7. `package.json` - M16.7 新增脚本

### 新增的文件

1. `scripts/m16-gold-promote.ts` - M16.7 Gold Promotion 核心实现
2. `scripts/test-m16.7-gold-promote.ts` - M16.7 测试脚本
3. `docs/M16.7_GOLD_BASELINE.md` - M16.7 文档

### 新增的目录

1. `baseline/gold/` - Gold Baseline 目录
2. `baseline/gold/history/` - Gold 历史留档目录

---

## 测试验证

### 本地测试

```bash
npm run test:m16.7
```

**测试结果**：
- ✓ Test 1: Cold start 第一次通过 - PASSED
- ✓ Test 2: 第二次连续通过 - PASSED
- ✓ Test 3: Gate 失败不覆盖 - PASSED
- ✓ Test 4: 非连续通过 - PASSED

**总计**：4/4 tests passed

---

## PM 审计清单

### P0 验证

- [x] `pressureMultiplier < 0.9` 真的变"更柔"（移除硬词、精简提示）
- [x] `pressureMultiplier > 1.1` 真的变"更强"（加入硬词、增加提示）
- [x] `meta_policy.json` 不再出现 `unknown__MID` 桶（或标注为 fallback-only）

### M16.6.1 稳定性验证

- [x] errorRate Beta 平滑生效（样本少时不暴涨）
- [x] SPIKE 上限 cap 生效（EP6/12/18 除外）

### M16.7 Gold Baseline 验证

- [x] CI main push 第二次满足条件后：
  - [x] `baseline/gold/m16_metrics_gold.json` 更新
  - [x] `baseline/gold/history/...` 留档
  - [x] `baseline/gold/pending.json` 被清空

### 安全保障

- [x] 任何情况下禁止自动覆盖 `baseline/m16_metrics_baseline.json`
- [x] 只允许写 `baseline/gold/*`

---

## 后续建议

### 1. 可视化仪表盘

展示 Gold 演进历史和 Metrics 差异对比

### 2. 自动回滚机制

如果新 Gold 导致测试失败，自动回滚到上一个版本

### 3. Promotion 条件调优

根据实际运行数据调整 Gate 条件（如降低 score 要求或放宽 p95Retries）

---

## 总结

M16.7 Gold Baseline 实现了：

1. **P0 问题修复**
   - pressureMultiplier 语义统一（< 0.9 更柔，> 1.1 更强）
   - unknown bucket 排除学习（只做 fallback）

2. **M16.6.1 稳定性增强**
   - errorRate Beta 平滑（防止样本少时暴涨）
   - SPIKE 上限 cap（防止反馈环路震荡）

3. **M16.7 Gold Baseline**
   - 可控演进（严格 Promotion Gate）
   - 可回滚（History 留档）
   - 安全机制（Pending 防止偶然晋升）
   - CI 集成（自动化 promotion）

配合 M16.6 Meta Policy，M16.7 完成了整个 Metrics 系统的最后一块拼图，实现了从"观测"到"优化"的完整闭环。

**PM 最终裁决**：M16.7 通过（PASS，且可进入下一阶段）✅

