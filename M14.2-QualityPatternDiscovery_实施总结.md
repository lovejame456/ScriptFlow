# M14.2 - Quality Pattern Discovery（质量结构模式发现）实施总结

## 一、任务目标

从 Quality Signals 的统计中，找出"高质量内容常见的结构组合模式"（pair/triple），以及低质量内容缺失的关键信号，输出人类可读的结构洞察，供人类决策复用。

**核心原则**：
- 不改 prompt
- 不影响生成
- 不自动反馈
- 只做离线分析 + 人类可读洞察

## 二、实施内容

### 2.1 类型定义扩展 (`types.ts`)

**新增 `QualityPattern` 接口**：

```typescript
export interface QualityPattern {
  patternKey: string;            // e.g. "conflictProgressed+costPaid"
  size: 2 | 3;                   // pair or triple
  occurrenceCount: number;       // 出现次数
  highQualityCoverage: number;   // 在高质量集中出现比例 (0-1)
  averageHitCount: number;       // 命中 signal 的平均数量
  description: string;           // 人类可读解释
}
```

**新增 `PatternDiscoveryResult` 接口**：

```typescript
export interface PatternDiscoveryResult {
  highQualityPatterns: QualityPattern[];  // 高质量集常见模式
  missingSignalsWarnings: {
    signalName: string;
    missingRate: number;  // 在低质量集中的缺失率 (0-1)
    description: string;
  }[];
  insights: string[];  // 人类可读洞察
}
```

### 2.2 模式发现核心逻辑 (`lib/ai/patternDiscovery.ts`)

**新建文件**，实现以下核心功能：

#### 2.2.1 `discoverPatterns()` - 主发现函数

输入 `SignalsSummary`，输出 `PatternDiscoveryResult`：

1. **数据分桶**
   - 高质量集：hitCount >= 4
   - 低质量集：hitCount <= 1
   - 中间区间：仅作背景统计

2. **组合生成**
   - 对每集的 true signals 生成所有 pair / triple 组合
   - Pair：C(6,2) = 15 种组合
   - Triple：C(6,3) = 20 种组合

3. **统计分析**
   - 统计每个 pattern 的出现次数
   - 计算在高质量集中的覆盖率
   - 计算平均命中信号数

4. **缺失信号分析**
   - 在低质量集中统计最常缺失的 signals
   - 缺失率 >= 70% 才输出警示

5. **洞察生成**
   - 生成 2-5 条人类可读的结构洞察

#### 2.2.2 辅助函数

- `generateCombinations()` - 生成 C(n, k) 组合
- `generateQualityPatterns()` - 生成高质量模式对象
- `analyzeMissingSignals()` - 分析缺失信号
- `generateInsights()` - 生成人类可读洞察
- `generatePatternDescription()` - 生成模式描述
- `generateMissingSignalDescription()` - 生成缺失信号描述

#### 2.2.3 Markdown 格式化函数

- `formatPatternsAsMarkdown()` - 格式化模式为 Markdown 表格
- `formatMissingSignalsAsMarkdown()` - 格式化缺失信号警示为 Markdown 列表
- `formatInsightsAsMarkdown()` - 格式化洞察为 Markdown 列表

**关键实现细节**：

- 边界情况处理：空 summary、缺少高质量集/低质量集的情况
- 避免噪声：仅统计至少出现 2 次的 pattern
- 约束遵守：只生成 2 或 3 个信号的组合，不做 4+
- 人类可读：所有输出都配有中文描述

### 2.3 E2E 测试脚本升级 (`scripts/test_deepseek_e2e.ts`)

**修改内容**：

1. **导入模式发现功能**
   ```typescript
   import { discoverPatterns, formatPatternsAsMarkdown, formatMissingSignalsAsMarkdown, formatInsightsAsMarkdown } from '../lib/ai/patternDiscovery';
   ```

2. **扩展 `TestReport` 接口**
   - 添加 `patternDiscovery?: PatternDiscoveryResult` 字段

3. **集成到测试流程**
   - 在 `runE2ETest()` 中调用 `discoverPatterns(signalsSummary)`
   - 将结果添加到 `TestReport`

4. **升级 Markdown 报告生成**
   - 新增"质量模式分析（M14.2）"章节
   - 输出 Top Quality Patterns 表格
   - 输出 Missing Signals Warnings
   - 输出结构洞察

### 2.4 单元测试 (`test-m14.2-pattern-discovery.ts`)

**新建测试文件**，覆盖以下场景：

1. ✓ 数据分桶正确（高质量集、低质量集）
2. ✓ 模式生成正确（至少发现一个高质量模式）
3. ✓ 缺失信号分析正确（至少发现一个警示）
4. ✓ 洞察生成正确（至少生成一条洞察）
5. ✓ 特定模式验证（stateCoherent 在高质量集命中）
6. ✓ 缺失信号验证（conflictProgressed 在低质量集缺失）
7. ✓ 模式大小约束（只有 2 或 3）
8. ✓ 覆盖率范围验证（0-1）
9. ✓ 边界情况：空 summary 处理正确

## 三、输出示例

### 3.1 单元测试输出示例

```
【Top Quality Patterns】

| Pattern | 大小 | 出现次数 | 高质量覆盖率 | 平均命中数 | 解读 |
|---------|------|---------|-------------|-----------|------|
| conflictProgressed+newReveal | 2 | 2 | 100.0% | 4.5 | Conflict Progressed + New Reveal 组合 |
| conflictProgressed+stateCoherent | 2 | 2 | 100.0% | 4.5 | Conflict Progressed + State Coherent 组合 |
| newReveal+stateCoherent | 2 | 2 | 100.0% | 4.5 | New Reveal + State Coherent 组合 |
| conflictProgressed+newReveal+stateCoherent | 3 | 2 | 100.0% | 4.5 | Conflict Progressed + New Reveal + State Coherent 组合 |

【Missing Signals Warnings】

- Conflict Progressed 缺失率 100% → Conflict Progressed 缺失率 100%，低质量集可能冲突推进缓慢
- Cost Paid 缺失率 100% → Cost Paid 缺失率 100%，低质量集可能缺乏角色代价设计
- Fact Reused 缺失率 100% → Fact Reused 缺失率 100%，低质量集可能缺乏连续性细节复用
- New Reveal 缺失率 100% → New Reveal 缺失率 100%，低质量集可能缺乏新信息揭示
- Promise Addressed 缺失率 100% → Promise Addressed 缺失率 100%，剧情常"埋而不收"

【人类可读洞察】

- 高质量集（≥4 signals）占比 40.0%
- "conflictProgressed+newReveal" 在高质量集中覆盖率 100%，是稳定有效的结构组合
- Conflict Progressed 在低质量集中缺失率 100%，需重点优化
- State Coherent 在高质量集中命中率 100%，是基础质量保障
- 高质量集平均命中 4.5 个信号，低质量集平均命中 0.5 个
```

### 3.2 E2E 报告示例

```markdown
## 质量模式分析（M14.2）

### Top Quality Patterns

以下模式在高高质量集中（≥4 signals）频繁出现：

| Pattern | 大小 | 出现次数 | 高质量覆盖率 | 平均命中数 | 解读 |
|---------|------|---------|-------------|-----------|------|
| stateCoherent+newReveal | 2 | 3/3 | 100.0% | 5.0 | State Coherent + New Reveal 组合 |

### Missing Signals Warnings

以下信号在低质量集中（≤1 signals）缺失率较高：

- Promise Addressed 缺失率 92% → Promise Addressed 缺失率 92%，剧情常"埋而不收"

### 结构洞察

- 高质量集（≥4 signals）占比 50.0%
- "stateCoherent+newReveal" 在高质量集中覆盖率 100%，是稳定有效的结构组合
- Promise Addressed 在低质量集中缺失率 92%，需重点优化
- State Coherent 在高质量集中命中率 100%，是基础质量保障
- 高质量集平均命中 5.0 个信号，低质量集平均命中 0.5 个
```

## 四、测试验证

### 4.1 单元测试结果

**测试文件**：`test-m14.2-pattern-discovery.ts`

**测试覆盖**：

1. ✓ 高质量集数量正确（2）
2. ✓ 低质量集数量正确（2）
3. ✓ 发现 4 个高质量模式
4. ✓ 发现 5 个缺失信号警示
5. ✓ 生成 5 条洞察
6. ✓ stateCoherent 在高质量集中出现（覆盖率 100.0%）
7. ✓ conflictProgressed 在低质量集中缺失率高（100%）
8. ✓ 所有模式大小符合约束（只有 2 或 3）
9. ✓ 所有覆盖率在有效范围内（0-1）
10. ✓ 空 summary 边界情况处理正确

**所有测试通过** ✅

### 4.2 回归测试

**M14.1 测试验证**：
- 运行 `test-m14.1-signals-aggregation.ts`，所有测试通过 ✅
- 证明 M14.2 没有破坏现有功能

## 五、文件修改清单

### 5.1 新建文件

1. **`lib/ai/patternDiscovery.ts`** - 模式发现核心逻辑（约 450 行）
2. **`test-m14.2-pattern-discovery.ts`** - 单元测试（约 240 行）

### 5.2 修改文件

1. **`types.ts`**
   - 新增 `QualityPattern` 接口
   - 新增 `PatternDiscoveryResult` 接口
   - 修改行数：+36 行

2. **`scripts/test_deepseek_e2e.ts`**
   - 导入模式发现功能
   - 扩展 `TestReport` 接口
   - 集成模式发现功能到测试流程
   - 升级 Markdown 报告生成
   - 修改行数：约 +50 行

## 六、关键设计决策

### 6.1 仅分析 pair / triple 组合

组合只看 2-3 个信号的原因：
- Pair：C(6,2) = 15 种，样本充足
- Triple：C(6,3) = 20 种，仍有统计意义
- 4+：C(6,4) = 15 种，但样本稀疏、噪声大

### 6.2 缺失信号阈值 70%

只有缺失率 >= 70% 才输出警示，原因：
- 避免过度敏感
- 突出真正的问题信号
- 提供可操作的警示

### 6.3 模式过滤条件

只统计至少出现 2 次的 pattern，原因：
- 避免单次偶然
- 提高模式可靠性
- 减少噪声

### 6.4 洞察生成策略

最多生成 5 条洞察，每条都指导结构决策：
- 高质量集占比
- Top 1 高质量模式
- Top 1 缺失信号
- stateCoherent 命中情况
- 平均命中数对比

## 七、约束条件验证

✅ **不改 prompt**：模式发现完全独立于生成流程

✅ **不影响生成**：离线分析，不参与生成决策

✅ **不自动反馈**：仅做统计与展示，供人工分析

✅ **只做离线分析**：仅在报告层使用

✅ **不做 4+ 组合**：严格遵守约束

✅ **不做评分**：不输出任何评分或自动选择

## 八、数据流图

```
SignalsSummary (M14.1)
    ↓
数据分桶
├─ 高质量集 (hitCount >= 4)
├─ 低质量集 (hitCount <= 1)
└─ 中间区间 (2-3)
    ↓
组合生成
├─ Pairs: C(6,2) = 15
└─ Triples: C(6,3) = 20
    ↓
统计分析
├─ 统计出现次数
├─ 计算高质量覆盖率
└─ 计算平均命中数
    ↓
缺失信号分析
└─ 低质量集中缺失率 >= 70%
    ↓
洞察生成
└─ 2-5 条人类可读洞察
    ↓
PatternDiscoveryResult
    ↓
E2E 报告输出
├─ Markdown 表格 + 列表
└─ JSON 结构化数据
```

## 九、PM 视角的 3 个问题回答

### 问题 1：高质量集（≥4/6 signals）最常出现哪些信号组合？

**答案**：通过 `highQualityPatterns` 列表展示

- 按 `highQualityCoverage` 降序排序
- 每个模式包含：patternKey、大小、出现次数、覆盖率、解读
- 示例："conflictProgressed+newReveal" 覆盖率 100%，说明"推进 + 揭示"是稳定有效结构

### 问题 2：低质量集（≤1/6 signals）通常缺失哪些关键信号？

**答案**：通过 `missingSignalsWarnings` 列表展示

- 按 `missingRate` 降序排序
- 每个警示包含：signalName、缺失率、描述
- 示例："Promise Addressed 缺失率 92%，剧情常'埋而不收'"

### 问题 3：是否存在稳定的"组合效应"（例如 A+B 比单独 A 更有效）？

**答案**：通过 `highQualityPatterns` 的覆盖率分析

- 如果 pattern 的高质量覆盖率显著高于单个 signal 的命中率，说明存在组合效应
- 示例："stateCoherent+newReveal" 覆盖率 100%，而单独的 newReveal 命中率可能只有 60%，说明"状态一致 + 新揭示"的组合效应明显

## 十、验收标准验证

- ✅ 能基于 SignalsSummary 生成 Top patterns（pair / triple）
- ✅ 能生成缺失信号警示
- ✅ 输出稳定、可读、可解释
- ✅ 不影响任何生成流程（M14.1 测试通过）
- ✅ 所有现有测试继续通过（M14.1 回归测试通过）
- ✅ 新增单元测试全部通过（10/10）

## 十一、下一步展望

M14.2 完成后，系统已经具备了质量信号的"模式发现能力"。M14 的后续阶段可以基于此进行：

1. **跨 Project 聚合**：统计不同项目/题材的模式分布
2. **时间趋势分析**：观察模式随集数增加的变化
3. **定向优化**：基于模式调整 Skeleton 侧重点、enrich 顺序、prompt 微调

**核心原则不变**：系统提供"显微镜"，决策仍在你手里。

## 十二、总结

M14.2 成功实现了质量结构模式发现功能，为后续质量反馈回路提供了模式级的数据基础。所有测试通过，功能稳定可靠。

### 实施成果

- ✅ 类型定义完整
- ✅ 模式发现逻辑健壮
- ✅ E2E 报告升级
- ✅ 单元测试覆盖
- ✅ 边界情况处理
- ✅ 约束条件严格遵守

### 交付物

1. `types.ts` - 新增 `QualityPattern` 和 `PatternDiscoveryResult` 接口
2. `lib/ai/patternDiscovery.ts` - 模式发现核心逻辑
3. `scripts/test_deepseek_e2e.ts` - 集成模式发现功能的 E2E 测试
4. `test-m14.2-pattern-discovery.ts` - 完整的单元测试
5. 本实施总结文档

---

**实施时间**：2026-01-03
**实施者**：Cursor AI Assistant
**测试状态**：✅ 全部通过
**PM 方向锁定**：系统现在可以"知道哪些结构组合，反复和好内容一起出现"，为 M14.3 / M15 的定向调整奠定基础

